name: Tests

on:
  push:
    branches:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync submodules
        run: git submodule update --init --recursive

      - name: Set up GraalVM 25
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: '25'
          cache: gradle

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-25.05

      - uses: cachix/cachix-action@v14
        with:
          name: undefined01
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Verify toolchain
        run: |
          set -euo pipefail
          java -version
          if command -v gu >/dev/null 2>&1; then
            gu --version
          fi
          nix --version

      - name: Build emulator distribution
        run: |
          set -euo pipefail
          ./gradlew --no-daemon installDist
          TEMU_BIN_PATH="temu/build/install/temu/bin/temu"
          if [ ! -x "${TEMU_BIN_PATH}" ]; then
            echo "temu binary not found at ${TEMU_BIN_PATH}" >&2
            exit 1
          fi
          echo "TEMU_BIN=${TEMU_BIN_PATH}" >> "$GITHUB_ENV"
      
      - name: Build test programs
        run: |
          set -euo pipefail
          cd temu/src/test/
          
          nix-build -A packages.asm.instr-test >> nix-out
          nix-build -A packages.asm.riscv-test >> nix-out
          nix-build -A packages.abstract-machine >> nix-out
          nix-build -A packages.linux >> nix-out

          mkdir build
          cat nix-out | while read -r line; do
            tar xaf $PWD/build/$line.tar.xz -C $line .
          done
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: temu-test-artifacts
          path: build/*

      - name: Instruction-level tests
        run: |
          set -euo pipefail
          RISCV_BIN_DIR=$(nix-build -A packages.asm.instr-test temu/src/test/default.nix)/bin
          TEMU_BIN="${{ env.TEMU_BIN }}"
          ls -al $RISCV_BIN_DIR
          find "${RISCV_BIN_DIR}" -name '*-p-*.bin' -print0 | while IFS= read -r -d '' bin; do
            echo "Running ${bin}"
            log="$(mktemp)"
            if ! "${TEMU_BIN}" "${bin}" 2>&1 | tee "${log}"; then
              cat "${log}"
              exit 1
            fi
            if ! grep -q 'with code 0' "${log}"; then
              cat "${log}"
              echo "ERROR: Test failed ${bin}"
              exit 1
            fi
            rm -f "${log}"
          done

      - name: Board-level tests
        env:
          SDL_VIDEODRIVER: dummy
        run: |
          set -euo pipefail
          BIN_DIR=$(nix-build -A packages.abstract-machine temu/src/test/default.nix)/bin
          TEMU_BIN="${{ env.TEMU_BIN }}"
          ls -al $BIN_DIR
          for bin in "${BIN_DIR}"/hello-*.bin "${BIN_DIR}"/coremark*.bin "${BIN_DIR}"/microbench-*.bin; do
            echo "Running ${bin}"
            log="$(mktemp)"
            if ! "${TEMU_BIN}" "${bin}" 2>&1 | tee "${log}"; then
              cat "${log}"
              exit 1
            fi
            if ! grep -q 'Shutdown requested' "${log}"; then
              cat "${log}"
              echo "ERROR: Test failed ${bin}"
              exit 1
            fi
            rm -f "${log}"
          done
