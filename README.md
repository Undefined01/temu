# TEMU


To build this project, ensure you have [GraalVM](https://www.graalvm.org/) 25 installed and set up on your system. You can then use the following command to build the project:

```
./gradlew installDist
```

You can find the executable in `temu/build/install/temu` directory after building the project, and run it with the following command:

```
temu/build/install/temu/bin/temu <riscv-binary>
```

The `<riscv-binary>` should be linked at address `0x80000000` and in raw binary format, which can be generated by `objcopy` with the `-O binary` option.

Some useful options for running the emulator:

```
export JAVA_OPTS="-Djdk.graal.Dump=Truffle:5 -Djdk.graal.PrintGraph=Network -XX:StartFlightRecording=filename=test.jfr -Xss128M"
temu/build/install/temu/bin/temu --engine.CompileImmediately --engine.BackgroundCompilation=false --engine.TraceCompilation temu/src/test/asm/instr-test/build/addi.bin

temu/build/install/temu/bin/temu temu/src/test/abstract-machine/repo/apps/coremark/build/coremark-10000-iteration-riscv64-nemu.bin --engine.TraceCompilationDetails --engine.CompilationStatistics --engine.TraceCompilationAST --compiler.TraceInlining --compiler.TracePerformanceWarnings=all --engine.SpecializationStatistics --log.file=a.txt
```

# Tests

There are some tests for each components. To build the test binaries, you need to have `riscv64-linux-gnu-gcc`, `riscv64-linux-gnu-g++`, and `make` installed on your system.

## Instruction-level Tests

These tests are located in the `temu/src/test/asm` directory and are written in assembly language. They only have limited dependencies on the emulator, making them easy to run and debug.

**Instruction Tests**

```
make -C temu/src/test/asm/instr-test
./gradlew :temu:test
```

**Riscv Tests**

```
make -C temu/src/test/asm/riscv-test
find temu/src/test/asm/riscv-test/build/ -name '*-p-*.bin' -exec bash -c "echo {}; (temu/build/install/temu/bin/temu '{}' 2>&1 | grep 'with code 0' >/dev/null) || echo 'ERROR: Test failed {}'" \;
```

## Board-level Tests

These tests are located in the `temu/src/test/abstract-machine` directory and make use of the abstract machine interface to build and run various C applications.

They require a more complete environment and will interact with the devices like RTC, VGA, etc.

**coremark**

```
make -C temu/src/test/abstract-machine coremark
temu/build/install/temu/bin/temu temu/src/test/abstract-machine/build/coremark-riscv64-nemu.bin
```

You can specify the number of iterations by setting the `ITERATIONS` variable:

```
make -C temu/src/test/abstract-machine coremark ITERATIONS=100000
temu/build/install/temu/bin/temu temu/src/test/abstract-machine/build/coremark-10000-iteration-riscv64-nemu.bin
```

Result:
```
Running CoreMark for 300000 iterations
2K performance run parameters for coremark.
CoreMark Size    : 666
Total time (ms)  : 30021
Iterations       : 300000
Compiler version : GCC10.2.1 20210110
seedcrc          : 0xe9f5
[0]crclist       : 0xe714
[0]crcmatrix     : 0x1fd7
[0]crcstate      : 0x8e3a
[0]crcfinal      : 0xcc42
Finished in 30021 ms.
==================================================
CoreMark Iterations/Sec 9993004.90
website.lihan.temu.cpu.HaltException: Halt at 80002794 with code 0
```

100x faster than NEMU:
```
Welcome to riscv32-NEMU!
For help, type "help"
Running CoreMark for 10000 iterations
2K performance run parameters for coremark.
CoreMark Size    : 666
Total time (ms)  : 101891
Iterations       : 10000
Compiler version : GCC10.2.1 20210110
seedcrc          : 0xe9f5
[0]crclist       : 0xe714
[0]crcmatrix     : 0x1fd7
[0]crcstate      : 0x8e3a
[0]crcfinal      : 0x988c
Finished in 101891 ms.
==================================================
CoreMark Iterations/Sec 98144.10
[src/cpu/cpu-exec.c:158 cpu_exec] nemu: HIT GOOD TRAP at pc = 0x800025c8
[src/cpu/cpu-exec.c:114 statistic] host time spent = 101,893,181 us
[src/cpu/cpu-exec.c:115 statistic] total guest instructions = 3,083,510,233
[src/cpu/cpu-exec.c:117 statistic] simulation frequency = 30,262,184 inst/s
```

0.7x faster than QEMU with TCG:
```
Running CoreMark for 300000 iterations
2K performance run parameters for coremark.
CoreMark Size    : 666
Total time (ms)  : 50956
Iterations       : 300000
Compiler version : GCC10.2.1 20210110
seedcrc          : 0xe9f5
[0]crclist       : 0xe714
[0]crcmatrix     : 0x1fd7
[0]crcstate      : 0x8e3a
[0]crcfinal      : 0xcc42
Finished in 50956 ms.
==================================================
CoreMark Iterations/Sec 5887432.29
```

3x slower than native:
```
Running CoreMark for 300000 iterations
2K performance run parameters for coremark.
CoreMark Size    : 666
Total time (ms)  : 10101
Iterations       : 300000
Compiler version : GCC10.2.1 20210110
seedcrc          : 0xe9f5
[0]crclist       : 0xe714
[0]crcmatrix     : 0x1fd7
[0]crcstate      : 0x8e3a
[0]crcfinal      : 0xcc42
Finished in 10101 ms.
==================================================
CoreMark Iterations/Sec 29700029.70
```

**microbench**

```
make -C temu/src/test/abstract-machine microbench
# make -C temu/src/test/abstract-machine microbench ARCH=riscv32-nemu
temu/build/install/temu/bin/temu temu/src/test/abstract-machine/build/microbench-riscv64-nemu.bin
```

Result:
```
Empty mainargs. Use "ref" by default
======= Running MicroBench [input *ref*] =======
[qsort] Quick sort: * Passed.
  min time: 274 ms [1866]
[queen] Queen placement: * Passed.
  min time: 133 ms [3539]
[bf] Brainf**k interpreter: * Passed.
  min time: 2325 ms [1018]
[fib] Fibonacci number: * Passed.
  min time: 511 ms [5541]
[sieve] Eratosthenes sieve: * Passed.
  min time: 198 ms [19879]
[15pz] A* 15-puzzle search: * Passed.
  min time: 258 ms [1738]
[dinic] Dinic's maxflow algorithm: * Passed.
  min time: 388 ms [2804]
[lzip] Lzip compression: * Passed.
  min time: 256 ms [2966]
[ssort] Suffix sort: * Passed.
  min time: 199 ms [2263]
[md5] MD5 digest: * Passed.
  min time: 219 ms [7871]
==================================================
MicroBench PASS        4948 Marks
                   vs. 100000 Marks (i7-7700K @ 4.20GHz)
Total time: 5360 ms
website.lihan.temu.cpu.HaltException: Halt at 80005460 with code 0
```

Compared to NEMU:
```
Welcome to riscv32-NEMU!
For help, type "help"
Empty mainargs. Use "ref" by default
======= Running MicroBench [input *ref*] =======
[qsort] Quick sort: * Passed.
  min time: 792 ms [645]
[queen] Queen placement: * Passed.
  min time: 1148 ms [410]
[bf] Brainf**k interpreter: * Passed.
  min time: 6435 ms [367]
[fib] Fibonacci number: * Passed.
  min time: 12230 ms [231]
[sieve] Eratosthenes sieve: * Passed.
  min time: 12942 ms [304]
[15pz] A* 15-puzzle search: * Passed.
  min time: 1538 ms [291]
[dinic] Dinic's maxflow algorithm: * Passed.
  min time: 2137 ms [509]
[lzip] Lzip compression: * Passed.
  min time: 1889 ms [401]
[ssort] Suffix sort: * Passed.
  min time: 780 ms [577]
[md5] MD5 digest: * Passed.
  min time: 11995 ms [143]
==================================================
MicroBench PASS        387 Marks
                   vs. 100000 Marks (i7-7700K @ 4.20GHz)
Total time: 59347 ms
[src/cpu/cpu-exec.c:158 cpu_exec] nemu: HIT GOOD TRAP at pc = 0x80005130
[src/cpu/cpu-exec.c:114 statistic] host time spent = 59,348,084 us
[src/cpu/cpu-exec.c:115 statistic] total guest instructions = 1,872,537,107
[src/cpu/cpu-exec.c:117 statistic] simulation frequency = 31,551,770 inst/s
```

Compared to native:
```
Empty mainargs. Use "ref" by default
======= Running MicroBench [input *ref*] =======
[qsort] Quick sort: * Passed.
  min time: 6 ms [85233]
[queen] Queen placement: * Passed.
  min time: 6 ms [78450]
[bf] Brainf**k interpreter: * Passed.
  min time: 35 ms [67637]
[fib] Fibonacci number: * Passed.
  min time: 27 ms [104881]
[sieve] Eratosthenes sieve: * Passed.
  min time: 39 ms [100925]
[15pz] A* 15-puzzle search: * Passed.
  min time: 6 ms [74766]
[dinic] Dinic's maxflow algorithm: * Passed.
  min time: 8 ms [136025]
[lzip] Lzip compression: * Passed.
  min time: 10 ms [75930]
[ssort] Suffix sort: * Passed.
  min time: 5 ms [90080]
[md5] MD5 digest: * Passed.
  min time: 18 ms [95772]
==================================================
MicroBench PASS        90969 Marks
                   vs. 100000 Marks (i7-7700K @ 4.20GHz)
Total time: 207 ms
```

**fceux**

You can comment out the `HAS_GUI` macro in `temu/src/test/abstract-machine/repo/apps/fceux/src/drivers/sdl/sdl-video.cpp` if you don't have GUI support.

```
make -C temu/src/test/abstract-machine fceux
temu/build/install/temu/bin/temu temu/src/test/abstract-machine/build/fceux-riscv64-nemu.bin
```

You can switch to other test programs in the `temu/src/test/abstract-machine/repo/share/games/nes/rom` directory by specifying the mainargs option:

```
make -C temu/src/test/abstract-machine fceux mainargs=mario
temu/build/install/temu/bin/temu temu/src/test/abstract-machine/build/fceux-riscv64-nemu.bin
```

## OS-level Tests

These tests are located in the `temu/src/test/rt-thread` directory and run a simple operating system on the emulator, which provides basic system calls and a shell interface.

To build rt-thread, you need to have `scons` installed on your system.

```
make -C temu/src/test/rt-thread-am
temu/build/install/temu/bin/temu temu/src/test/rt-thread-am/repo/bsp/abstract-machine/build/rtthread-riscv64-nemu.bin
```

```
make -C temu/src/test/rt-thread
temu/build/install/temu/bin/temu temu/src/test/rt-thread/repo/bsp/abstract-machine/build/rtthread-riscv64-nemu.bin
```

