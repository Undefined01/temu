From 9422eb104548e32d3840edcf2bc703e578721e46 Mon Sep 17 00:00:00 2001
From: Undefined01 <amoscr@163.com>
Date: Sun, 21 Sep 2025 23:48:15 +0800
Subject: [PATCH 1/2] Patched for TEMU

---
 am/arch/riscv64-nemu.mk            |  2 ++
 am/src/nemu/include/nemu.h         | 26 +++++++++++++-------------
 am/src/nemu/isa/riscv/boot/start.S |  7 -------
 am/src/nemu/isa/riscv/cte64.c      |  1 -
 am/src/nemu/isa/riscv/trm.c        |  4 ++--
 apps/fceux/src/config.h            | 16 ++++++++--------
 libs/klib/include/klib.h           |  4 ----
 libs/klib/src/atomic.c             | 30 ------------------------------
 libs/klib/src/stdlib.c             | 10 +++++-----
 9 files changed, 30 insertions(+), 70 deletions(-)
 delete mode 100644 libs/klib/src/atomic.c

diff --git a/am/arch/riscv64-nemu.mk b/am/arch/riscv64-nemu.mk
index cfd1c6d5..3ffbcb7a 100644
--- a/am/arch/riscv64-nemu.mk
+++ b/am/arch/riscv64-nemu.mk
@@ -1,3 +1,5 @@
+MARCH = rv64im -mabi=lp64
+
 include $(AM_HOME)/am/arch/isa/riscv64.mk
 include $(AM_HOME)/am/arch/platform/nemu.mk
 
diff --git a/am/src/nemu/include/nemu.h b/am/src/nemu/include/nemu.h
index 853a779c..a7f0862f 100644
--- a/am/src/nemu/include/nemu.h
+++ b/am/src/nemu/include/nemu.h
@@ -29,19 +29,19 @@
 # define RTC_ADDR     0x1f1000bff8
 // CLINT 0x1f00000000
 #else
-# define SERIAL_PORT  0xa10003f8
-# define KBD_ADDR     0xa1000060
-# define RTC_ADDR     0xa1000048
-# define SCREEN_ADDR  0xa1000100
-# define SYNC_ADDR    0xa1000104
-# define FB_ADDR      0xa0000000
-# define AUDIO_FREQ_ADDR      0xa1000200
-# define AUDIO_CHANNELS_ADDR  0xa1000204
-# define AUDIO_SAMPLES_ADDR   0xa1000208
-# define AUDIO_SBUF_SIZE_ADDR 0xa100020c
-# define AUDIO_INIT_ADDR      0xa1000210
-# define AUDIO_COUNT_ADDR     0xa1000214
-# define AUDIO_SBUF_ADDR      0xa0800000
+# define SERIAL_PORT  0xa00003f8
+# define KBD_ADDR     0xa0000060
+# define RTC_ADDR     0xa0000048
+# define SCREEN_ADDR  0xa0000100
+# define SYNC_ADDR    0xa0000104
+# define FB_ADDR      0xa1000000
+# define AUDIO_FREQ_ADDR      0xa0000200
+# define AUDIO_CHANNELS_ADDR  0xa0000204
+# define AUDIO_SAMPLES_ADDR   0xa0000208
+# define AUDIO_SBUF_SIZE_ADDR 0xa000020c
+# define AUDIO_INIT_ADDR      0xa0000210
+# define AUDIO_COUNT_ADDR     0xa0000214
+# define AUDIO_SBUF_ADDR      0xa1200000
 #endif
 
 extern char _pmem_start, _pmem_end;
diff --git a/am/src/nemu/isa/riscv/boot/start.S b/am/src/nemu/isa/riscv/boot/start.S
index 482e1f60..291031ca 100644
--- a/am/src/nemu/isa/riscv/boot/start.S
+++ b/am/src/nemu/isa/riscv/boot/start.S
@@ -32,16 +32,9 @@
 _start:
   init_regs
 
-  li a0, MSTATUS_FS & (MSTATUS_FS >> 1)
-  csrs mstatus, a0
-  csrwi fcsr, 0
-
-  init_fregs # init fregs after fp enable
-
   la t0, _stack_top
   la t1, _stack_pointer
   sub t3, t1, t0
-  csrr t4, mhartid
   mul t5, t3, t4
   add sp, t5, t1
 
diff --git a/am/src/nemu/isa/riscv/cte64.c b/am/src/nemu/isa/riscv/cte64.c
index 6c0350e0..737341c7 100644
--- a/am/src/nemu/isa/riscv/cte64.c
+++ b/am/src/nemu/isa/riscv/cte64.c
@@ -14,7 +14,6 @@ extern void enable_timer();
 extern void init_pmp(); 
 extern void enable_pmp(uintptr_t pmp_reg, uintptr_t pmp_addr, uintptr_t pmp_size, uint8_t lock, uint8_t permission);
 extern void enable_pmp_TOR(uintptr_t pmp_reg, uintptr_t pmp_addr, uintptr_t pmp_size, bool lock, uint8_t permission);
-#include <csr.h>
 
 static void init_eip() {
   // enable machine external interrupt (mie.meip and mstatus.mie)
diff --git a/am/src/nemu/isa/riscv/trm.c b/am/src/nemu/isa/riscv/trm.c
index 53dbd326..2f5b6215 100644
--- a/am/src/nemu/isa/riscv/trm.c
+++ b/am/src/nemu/isa/riscv/trm.c
@@ -1,11 +1,11 @@
 #include <nemu.h>
 
 void _putc(char ch) {
-  outb(0xa10003f8, ch);
+  outb(SERIAL_PORT, ch);
 }
 
 void _halt(int code) {
-  asm volatile("mv a0, %0; .word 0x0000006b" : :"r"(code));
+  asm volatile("mv a0, %0; ebreak" : :"r"(code));
 
   // should not reach here
   while (1);
diff --git a/apps/fceux/src/config.h b/apps/fceux/src/config.h
index 7089ecc5..e4bb560c 100644
--- a/apps/fceux/src/config.h
+++ b/apps/fceux/src/config.h
@@ -5,15 +5,15 @@
 #define SOUND_LQ   1
 #define SOUND_HQ   2
 
-#if defined(__PLATFORM_NEMU__)
-# define NR_FRAMESKIP 1
-# define SOUND_CONFIG SOUND_LQ
-#elif defined(__PLATFORM_NOOP__) || defined(__PLATFORM_SDI__) || defined(__PLATFORM_NAVY__)
+// #if defined(__PLATFORM_NEMU__)
+// # define NR_FRAMESKIP 1
+// # define SOUND_CONFIG SOUND_LQ
+// #elif defined(__PLATFORM_NOOP__) || defined(__PLATFORM_SDI__) || defined(__PLATFORM_NAVY__)
 # define NR_FRAMESKIP 2
 # define SOUND_CONFIG SOUND_NONE
-#else
-# define NR_FRAMESKIP 0
-# define SOUND_CONFIG SOUND_HQ
-#endif
+// #else
+// # define NR_FRAMESKIP 0
+// # define SOUND_CONFIG SOUND_HQ
+// #endif
 
 #endif
diff --git a/libs/klib/include/klib.h b/libs/klib/include/klib.h
index 361c2eab..d0cb0a6e 100644
--- a/libs/klib/include/klib.h
+++ b/libs/klib/include/klib.h
@@ -78,10 +78,6 @@ void free(void *ptr);
 
 void qsort(void *base, size_t nmemb, size_t size, int (*compar)(const void *, const void *));
 
-uint64_t compare_and_swap(volatile uint64_t*, uint64_t, uint64_t);
-void lock(volatile uint64_t *);
-void release(volatile uint64_t *);
-
 // assert.h
 #ifdef NDEBUG
   #define assert(ignore) ((void)0)
diff --git a/libs/klib/src/atomic.c b/libs/klib/src/atomic.c
deleted file mode 100644
index d98ef7da..00000000
--- a/libs/klib/src/atomic.c
+++ /dev/null
@@ -1,30 +0,0 @@
-#include "klib.h"
-#include <klib-macros.h>
-
-uint64_t compare_and_swap(volatile uint64_t* addr, uint64_t old_val, uint64_t new_val) {
-  uint64_t check = 0;
-  uint64_t value = 0;
-  asm volatile (
-    "lr.d %[value], (%[addr]);"
-    : [value]"=r"(value)
-    : [addr]"p"(addr)
-  );
-  if (value != old_val) return 1;
-  asm volatile (
-    "sc.d %[check], %[write], (%[addr]);"
-    : [check]"=r"(check)
-    : [write]"r"(new_val), [addr]"p"(addr)
-  );
-  return check;
-}
-
-void lock(volatile uint64_t *addr) {
-  asm volatile("csrci mstatus, 0x8");
-  while(compare_and_swap(addr, 0, 1));
-}
-
-void release(volatile uint64_t *addr) {
-  *addr = 0;
-  asm volatile("fence");
-  asm volatile("csrsi mstatus, 0x8");
-}
\ No newline at end of file
diff --git a/libs/klib/src/stdlib.c b/libs/klib/src/stdlib.c
index 18966846..0134a44b 100644
--- a/libs/klib/src/stdlib.c
+++ b/libs/klib/src/stdlib.c
@@ -36,7 +36,7 @@ static struct {
 volatile uint64_t malloc_lock = 0;
 
 void *malloc(size_t size) {
-  lock(&malloc_lock);
+  // lock(&malloc_lock);
   if (last.ptr == NULL) {
     last.ptr = _heap.start;
     printf("heap start = %x\n", last.ptr);
@@ -48,19 +48,19 @@ void *malloc(size_t size) {
   // skip the region allocated by the last call
   last.ptr += last.size;
   if (last.ptr + size >= _heap.end) {
-    release(&malloc_lock);
+    // release(&malloc_lock);
     return NULL;
   }
   void *ret = last.ptr;
   last.size = size;
-  release(&malloc_lock);
+  // release(&malloc_lock);
   return ret;
 }
 
 void free(void *ptr) {
-  lock(&malloc_lock);
+  // lock(&malloc_lock);
   if (ptr == last.ptr) last.size = 0;
-  release(&malloc_lock);
+  // release(&malloc_lock);
 }
 
 #endif
-- 
2.30.2

